<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FLAPPY BIRD</title>
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        body {
            background: black;
            color: #00ff00;
            font-family: "Courier New", monospace;
            font-size: 16px;
            line-height: 16px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            text-shadow: 0 0 4px #00ff00;
            overflow: hidden;
            cursor: none;
            padding: 20px;
        }
        .container {
            display: flex;
            gap: 20px;
            z-index: 1;
        }
        pre {
            white-space: pre;
            user-select: none;
            line-height: 1.0;
        }
        body::after {
            content: "";
            position: fixed;
            inset: 0;
            background: repeating-linear-gradient(
                to bottom,
                rgba(0,0,0,0) 0px,
                rgba(0,255,0,0.04) 2px,
                rgba(0,0,0,0) 4px
            );
            pointer-events: none;
            z-index: 100;
        }
        .loading-overlay {
            position: fixed;
            inset: 0;
            background: black;
            color: #00ff00;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            font-family: "Courier New", monospace;
            text-align: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }
        .loading-overlay.active {
            opacity: 1;
            pointer-events: all;
        }
        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }
        .loading-dots::after {
            content: '';
            animation: dots 1.5s infinite;
        }
        @media (max-width: 768px) {
            body {
                font-size: 12px;
            }
            .container {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
<div class="loading-overlay active" id="loadingOverlay">
    <pre style="font-size: 14px; line-height: 1.5;">
FLAPPY BIRD v1.0

<span class="loading-dots">LOADING</span>
    </pre>
</div>
<div class="container">
    <pre id="game"></pre>
    <pre id="ui"></pre>
</div>
<script>
const gameEl = document.getElementById("game");
const uiEl = document.getElementById("ui");
const WIDTH = 50;
const HEIGHT = 25;
const GAME_NAME = "FLAPPY BIRD";

const currentUser = localStorage.getItem("currentUser");

if (!currentUser) {
    alert("You must be logged in to play!");
    window.location.href = "../login/login.html";
}

let score = 0;
let highScore = 0;
let gameRunning = false;
let frameCount = 0;
let gameStarted = false;

let bird = {
    x: 10,
    y: Math.floor(HEIGHT / 2),
    velocity: 0,
    gravity: 0.5,
    jump: -2.5
};

let pipes = [];
const pipeWidth = 3;
const pipeGap = 8;
const pipeSpeed = 1;

let leaderboard = [];

function draw() {
    let out = "";
    
    out += "+" + "=".repeat(WIDTH - 2) + "+\n";
    
    for (let y = 0; y < HEIGHT; y++) {
        let line = "|";
        for (let x = 1; x < WIDTH - 1; x++) {
            let ch = " ";
            
            if (Math.floor(bird.y) === y && x === bird.x) {
                ch = "█";
            }
            
            pipes.forEach(pipe => {
                if (x >= pipe.x && x < pipe.x + pipeWidth) {
                    if (y < pipe.topHeight || y >= HEIGHT - pipe.bottomHeight) {
                        ch = "▓";
                    }
                }
            });
            
            line += ch;
        }
        line += "|\n";
        out += line;
    }
    
    out += "+" + "=".repeat(WIDTH - 2) + "+\n";
    
    if (!gameStarted) {
        out += "< PRESS SPACE OR UP ARROW TO START >\n";
    } else if (!gameRunning && gameStarted) {
        out += "< GAME OVER >\nPRESS SPACE TO RESTART\n";
    }
    
    gameEl.textContent = out;
    
    let ui = `FLAPPY BIRD v1.0
━━━━━━━━━━━━━━━━━━━━

SCORE: ${score}
HIGHSCORE: ${highScore}

━━━━━━━━━━━━━━━━━━━━
LEADERBOARD:
━━━━━━━━━━━━━━━━━━━━
`;
    
    if (leaderboard.length === 0) {
        ui += "(Loading...)\n";
    } else {
        leaderboard.slice(0, 8).forEach((entry) => {
            const username = entry.username.substring(0, 12).padEnd(12);
            const displayScore = entry.score || 0;
            ui += `${entry.rank}. ${username} ${displayScore}\n`;
        });
    }
    
    ui += `\n━━━━━━━━━━━━━━━━━━━━
CONTROLS:
━━━━━━━━━━━━━━━━━━━━
SPACE / UP = FLAP
AVOID PIPES [▓]

━━━━━━━━━━━━━━━━━━━━
ESC = BACK TO HOME
`;
    
    uiEl.textContent = ui;
}

function gameLoop() {
    if (!gameRunning) return;
    
    updateBird();
    updatePipes();
    
    if (score > highScore) {
        highScore = score;
    }
    
    if (checkCollision()) {
        gameOver();
        return;
    }
    
    draw();
    setTimeout(gameLoop, 80);
}

function updateBird() {
    bird.velocity += bird.gravity;
    bird.y += bird.velocity;
    
    if (bird.y < 0) {
        bird.y = 0;
        bird.velocity = 0;
    }
}

function updatePipes() {
    frameCount++;
    
    if (frameCount % 40 === 0) {
        let topHeight = Math.floor(Math.random() * (HEIGHT - pipeGap - 4)) + 2;
        let bottomHeight = HEIGHT - pipeGap - topHeight;
        pipes.push({
            x: WIDTH - 2,
            topHeight,
            bottomHeight,
            passed: false
        });
    }
    
    pipes.forEach(pipe => {
        pipe.x -= pipeSpeed;
        if (pipe.x + pipeWidth < bird.x && !pipe.passed) {
            score++;
            pipe.passed = true;
        }
    });
    
    pipes = pipes.filter(pipe => pipe.x + pipeWidth > 1);
}

function checkCollision() {
    if (Math.floor(bird.y) >= HEIGHT || bird.y < 0) return true;
    
    return pipes.some(pipe => {
        if (bird.x >= pipe.x && bird.x < pipe.x + pipeWidth) {
            if (Math.floor(bird.y) < pipe.topHeight || 
                Math.floor(bird.y) >= HEIGHT - pipe.bottomHeight) {
                return true;
            }
        }
        return false;
    });
}

async function gameOver() {
    gameRunning = false;
    
    await saveHighscore();
    await saveLeaderboard();
    await loadLeaderboard();
    
    draw();
}

function restartGame() {
    bird.y = Math.floor(HEIGHT / 2);
    bird.velocity = 0;
    pipes = [];
    score = 0;
    frameCount = 0;
    gameStarted = false;
    gameRunning = false;
    draw();
}

function startGame() {
    gameRunning = true;
    gameStarted = true;
    gameLoop();
}

function jump() {
    if (!gameStarted) {
        startGame();
    } else if (gameRunning) {
        bird.velocity = bird.jump;
    } else if (!gameRunning && gameStarted) {
        restartGame();
        setTimeout(() => startGame(), 100);
    }
}

async function loadHighScore() {
    try {
        const res = await fetch(
            `https://vtcade.onrender.com/api/highscore/${currentUser}/${GAME_NAME}`
        );

        if (res.ok) {
            const data = await res.json();
            highScore = data.highscore || 0;
        } else {
            highScore = 0;
        }
    } catch (err) {
        highScore = 0;
    }
}

async function saveHighscore() {
    try {
        const res = await fetch("https://vtcade.onrender.com/api/highscore/save", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                username: currentUser,
                game: GAME_NAME,
                score: score
            })
        });

        if (res.ok) {
            const data = await res.json();
            highScore = data.highscore;
        }
    } catch (err) {
    }
}

async function saveLeaderboard() {
    try {
        await fetch("https://vtcade.onrender.com/api/leaderboard/save", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                username: currentUser,
                game: GAME_NAME,
                score
            })
        });
    } catch (err) {
    }
}

async function loadLeaderboard() {
    try {
        const res = await fetch(`https://vtcade.onrender.com/api/leaderboard/${GAME_NAME}`);
        
        if (res.ok) {
            const data = await res.json();
            leaderboard = data.leaderboard || [];
            draw();
        } else {
            leaderboard = [];
        }
    } catch (err) {
        leaderboard = [];
    }
}

document.addEventListener("keydown", (e) => {
    if (e.code === "Space" || e.code === "ArrowUp") {
        e.preventDefault();
        jump();
    } else if (e.code === "Escape") {
        e.preventDefault();
        document.getElementById('loadingOverlay').classList.add('active');
        setTimeout(() => {
            window.location.href = "../../dashboard/dashboard.html";
        }, 800);
    }
});

document.addEventListener("click", (e) => {
    jump();
});

document.addEventListener("contextmenu", (e) => {
    e.preventDefault();
});

async function initGame() {
    try {
        await loadHighScore();
        await loadLeaderboard();
        restartGame();
    } catch (err) {
        restartGame();
    } finally {
        setTimeout(() => {
            document.getElementById('loadingOverlay').classList.remove('active');
        }, 500);
    }
}

if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initGame);
} else {
    initGame();
}
</script>
</body>
</html>