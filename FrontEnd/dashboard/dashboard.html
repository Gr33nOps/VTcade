<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VTcade - Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: black;
            color: #00ff00;
            font-family: "Courier New", monospace;
            font-size: 16px;
            line-height: 1.4;
            text-shadow: 0 0 4px #00ff00;
            overflow: hidden;
            cursor: none;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            width: 100%;
            max-width: 900px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        pre {
            white-space: pre;
            user-select: none;
            line-height: 1.4;
        }

        .terminal-output {
            font-size: 14px;
            text-align: left;
        }

        .logo {
            font-size: 10px;
            line-height: 1.1;
            text-align: center;
            margin-bottom: 0;
            animation: flicker 0.15s infinite alternate;
        }

        .subtitle {
            font-size: 14px;
            text-align: center;
            margin-top: 5px;
            display: block;
        }

        .highlight {
            background: #00ff00;
            color: black;
        }

        .dim {
            color: #006600;
        }

        .yellow {
            color: #00ff00;
        }

        .red {
            color: #ff0000;
        }

        body::after {
            content: "";
            position: fixed;
            inset: 0;
            background: repeating-linear-gradient(to bottom,
                    rgba(0, 0, 0, 0) 0px,
                    rgba(0, 255, 0, 0.04) 2px,
                    rgba(0, 0, 0, 0) 4px);
            pointer-events: none;
            z-index: 9999;
        }

        @keyframes blink {

            0%,
            49% {
                opacity: 1;
            }

            50%,
            100% {
                opacity: 0;
            }
        }

        .cursor {
            animation: blink 1s infinite;
        }

        @keyframes flicker {
            0% {
                opacity: 0.97;
            }

            100% {
                opacity: 1;
            }
        }

        .loading-overlay {
            position: fixed;
            inset: 0;
            background: black;
            color: #00ff00;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            font-family: "Courier New", monospace;
            text-align: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .loading-overlay.active {
            opacity: 1;
            pointer-events: all;
        }

        .loading-content {
            font-size: 14px;
            line-height: 1.5;
        }

        @keyframes dots {

            0%,
            20% {
                content: '.';
            }

            40% {
                content: '..';
            }

            60%,
            100% {
                content: '...';
            }
        }

        .loading-dots::after {
            content: '';
            animation: dots 1.5s infinite;
        }

        @media (max-width: 768px) {
            body {
                font-size: 12px;
                padding: 10px;
            }

            .terminal-output {
                font-size: 11px;
            }

            .logo {
                font-size: 7px;
            }

            .subtitle {
                font-size: 11px;
            }
        }

        @media (max-width: 480px) {
            body {
                font-size: 10px;
            }

            .terminal-output {
                font-size: 9px;
            }

            .logo {
                font-size: 5px;
            }

            .subtitle {
                font-size: 9px;
            }
        }
    </style>
</head>

<body>
    <div class="loading-overlay active" id="loadingOverlay">
        <div class="loading-content">
            <pre>
================================================================================

<span class="loading-dots">LOADING</span>

================================================================================
            </pre>
        </div>
    </div>

    <div class="container">
        <pre class="logo">
██╗   ██╗████████╗ ██████╗ █████╗ ██████╗ ███████╗
██║   ██║╚══██╔══╝██╔════╝██╔══██╗██╔══██╗██╔════╝
██║   ██║   ██║   ██║     ███████║██║  ██║█████╗  
╚██╗ ██╔╝   ██║   ██║     ██╔══██║██║  ██║██╔══╝  
 ╚████╔╝    ██║   ╚██████╗██║  ██║██████╔╝███████╗
  ╚═══╝     ╚═╝    ╚═════╝╚═╝  ╚═╝╚═════╝ ╚══════╝
                    <span class="subtitle">Play Like It's 1985</span></pre>
        <pre id="terminal" class="terminal-output"></pre>
    </div>

    <script>
        const API_BASE_URL = 'https://vtcade.onrender.com/api';
        const terminalEl = document.getElementById("terminal");
        let selectedIndex = 0;
        let currentPage = 0;
        const ITEMS_PER_PAGE_GAMES = 5;
        const ITEMS_PER_PAGE_SCORES = 10;
        let currentView = "menu";
        let username = "UNKNOWN";
        let userHighscores = {};
        let leaderboardData = [];
        let totalGamesPlayed = 0;
        let errorMessage = "";
        let selectedGame = null;

        const games = [
            { id: 1, name: "FLAPPY BIRD", url: "../games/flappyBird/game.html", available: true, apiName: "FLAPPY BIRD" },
            { id: 2, name: "RUNNER", url: "../games/runner/game.html", available: true, apiName: "RUNNER" },
            { id: 3, name: "SNAKE", url: "../games/snake/game.html", available: true, apiName: "SNAKE" },
            { id: 4, name: "PROGRAM 04", url: "../games/game4/game.html", available: false, apiName: "PROGRAM 04" },
            { id: 5, name: "PROGRAM 05", url: "../games/game5/game.html", available: false, apiName: "PROGRAM 05" }
        ];

        function checkLogin() {
            const user = localStorage.getItem("currentUser");
            if (!user) {
                window.location.href = "../login/login.html";
                return null;
            }
            return user;
        }

        async function fetchUserHighscores() {
            try {
                errorMessage = "";
                const response = await fetch(`${API_BASE_URL}/highscore/user/${username}`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const data = await response.json();

                console.log('Received highscores:', data); 

                if (data.scores) {
                    userHighscores = {};
                    data.scores.forEach(score => {
                        const gameName = score.game.trim().toUpperCase();
                        userHighscores[gameName] = score.highscore;
                        console.log(`Stored: ${gameName} = ${score.highscore}`); 
                    });
                    totalGamesPlayed = data.total;
                }
            } catch (error) {
                console.error('Error fetching highscores:', error);
                errorMessage = "Failed to load highscores";
                userHighscores = {};
                totalGamesPlayed = 0;
            }
        }

        async function fetchLeaderboard(game) {
            try {
                errorMessage = "";
                const response = await fetch(`${API_BASE_URL}/leaderboard/${encodeURIComponent(game)}?limit=100`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const data = await response.json();
                leaderboardData = data.leaderboard?.map(entry => ({
                    username: entry.username,
                    score: entry.score
                })) || [];
                if (leaderboardData.length === 0) {
                    errorMessage = "No scores found for this game";
                }
            } catch (error) {
                console.error('Error fetching leaderboard:', error);
                errorMessage = "Failed to load leaderboard";
                leaderboardData = [];
            }
        }

        function getDateTime() {
            const now = new Date();
            const date = now.toLocaleDateString('en-US', { year: 'numeric', month: '2-digit', day: '2-digit' });
            const time = now.toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });
            return { date, time };
        }

        function renderMenu() {
            const { date, time } = getDateTime();
            let output = `
================================================================================

SYSTEM STATUS: ONLINE
USER: ${username}
DATE: ${date}
TIME: ${time}

================================================================================
USER DASHBOARD
================================================================================

`;

            const menuItems = [
                { id: 1, name: "GAMES" },
                { id: 2, name: "MY HIGH SCORES" },
                { id: 3, name: "VIEW LEADERBOARD" },
                { id: 4, name: "LOGOUT" }
            ];

            menuItems.forEach((item, index) => {
                const isSelected = index === selectedIndex;
                const prefix = isSelected ? '>>>' : '   ';
                const line = `${prefix} [${item.id}] ${item.name}`;
                output += isSelected ? `<span class="highlight">${line}</span>\n` : line + '\n';
            });

            output += `
================================================================================
NAVIGATION
================================================================================

    [↑/↓]     Navigate Menu              [ENTER]     Select Option
    [1-4]     Direct Access             

================================================================================

READY: <span class="cursor">_</span>
`;
            terminalEl.innerHTML = output;
        }

        function renderGames() {
            const { date, time } = getDateTime();
            const start = currentPage * ITEMS_PER_PAGE_GAMES;
            const end = Math.min(start + ITEMS_PER_PAGE_GAMES, games.length);
            const visibleGames = games.slice(start, end);
            const totalPages = Math.ceil(games.length / ITEMS_PER_PAGE_GAMES) || 1;

            let output = `
================================================================================

SYSTEM STATUS: ONLINE
USER: ${username}
DATE: ${date}
TIME: ${time}

================================================================================
AVAILABLE GAMES (Page ${currentPage + 1}/${totalPages})
================================================================================

`;

            visibleGames.forEach((game, idx) => {
                const globalIndex = start + idx;
                const isSelected = globalIndex === selectedIndex;
                const prefix = isSelected ? '>>>' : '   ';
                const status = game.available ? '<span class="yellow">[READY]</span>' : '<span class="dim">[LOCKED]</span>';
                const line = `${prefix} [${game.id}] ${game.name.padEnd(25)} ${status}`;
                output += isSelected && game.available
                    ? `<span class="highlight">${line.replace(/<span[^>]*>|<\/span>/g, '')}</span>\n`
                    : line + '\n';
            });

            output += `
================================================================================
COMMANDS
================================================================================

    [↑/↓]     Navigate                 [←/→]       Change Page
    [ENTER]   Launch Game              [1-5]       Direct Launch
    [ESC]     Back to Menu

================================================================================

READY: <span class="cursor">_</span>
`;
            terminalEl.innerHTML = output;
        }

        function renderHighScores() {
            const { date, time } = getDateTime();
            let output = `
================================================================================

SYSTEM STATUS: ONLINE
USER: ${username}
DATE: ${date}
TIME: ${time}

================================================================================
MY HIGH SCORES
================================================================================

`;

            if (errorMessage) {
                output += `    <span class="red">ERROR: ${errorMessage}</span>\n\n`;
            }

            const availableGames = ['FLAPPY BIRD', 'RUNNER', 'SNAKE'];
            let totalScore = 0;
            let gamesWithScores = 0;

            availableGames.forEach(game => {
                const score = userHighscores[game] || 0;
                if (score > 0) {
                    totalScore += score;
                    gamesWithScores++;
                }
                const formattedScore = score.toLocaleString();
                output += `    ${game.padEnd(20)} ${formattedScore.padStart(10)} PTS\n`;
            });

            const avgScore = gamesWithScores > 0 ? Math.round(totalScore / gamesWithScores) : 0;

            output += `
    <span class="dim">Total Games Played: ${totalGamesPlayed}</span>
    <span class="dim">Average Score: ${avgScore.toLocaleString()} PTS</span>

================================================================================
COMMANDS
================================================================================

    [ESC]     Back to Menu

================================================================================

READY: <span class="cursor">_</span>
`;
            terminalEl.innerHTML = output;
        }

        function renderLeaderboardMenu() {
            const { date, time } = getDateTime();
            const availableGames = games.filter(g => g.available);
            const start = currentPage * ITEMS_PER_PAGE_GAMES;
            const end = Math.min(start + ITEMS_PER_PAGE_GAMES, availableGames.length);
            const visibleGames = availableGames.slice(start, end);
            const totalPages = Math.ceil(availableGames.length / ITEMS_PER_PAGE_GAMES) || 1;

            let output = `
================================================================================

SYSTEM STATUS: ONLINE
USER: ${username}
DATE: ${date}
TIME: ${time}

================================================================================
LEADERBOARD - SELECT GAME (Page ${currentPage + 1}/${totalPages})
================================================================================

`;

            visibleGames.forEach((game, idx) => {
                const globalIndex = start + idx;
                const isSelected = globalIndex === selectedIndex;
                const prefix = isSelected ? '>>>' : '   ';
                const line = `${prefix} [${globalIndex + 1}] ${game.name}`;
                output += isSelected ? `<span class="highlight">${line}</span>\n` : line + '\n';
            });

            output += `
================================================================================
COMMANDS
================================================================================

    [↑/↓]     Navigate                 [←/→]       Change Page
    [ENTER]   View Leaderboard          [ESC]       Back to Menu

================================================================================

READY: <span class="cursor">_</span>
`;
            terminalEl.innerHTML = output;
        }

        function renderLeaderboard() {
            const { date, time } = getDateTime();
            const start = currentPage * ITEMS_PER_PAGE_SCORES;
            const end = Math.min(start + ITEMS_PER_PAGE_SCORES, leaderboardData.length);
            const visibleScores = leaderboardData.slice(start, end);
            const totalPages = Math.ceil(leaderboardData.length / ITEMS_PER_PAGE_SCORES) || 1;

            let output = `
================================================================================

SYSTEM STATUS: ONLINE
USER: ${username}
DATE: ${date}
TIME: ${time}

================================================================================
LEADERBOARD - ${selectedGame.toUpperCase()} (Page ${currentPage + 1}/${totalPages})
================================================================================

`;

            if (errorMessage) {
                output += `    <span class="red">ERROR: ${errorMessage}</span>\n`;
            } else if (leaderboardData.length === 0) {
                output += `    <span class="dim">NO SCORES FOUND</span>\n`;
            } else {
                output += `    RANK  PLAYER             SCORE\n`;
                output += `    ----  ---------------    --------\n`;

                visibleScores.forEach((entry, idx) => {
                    const globalRank = start + idx + 1;
                    const rank = `#${globalRank}`.padEnd(6);
                    const player = entry.username.substring(0, 15).padEnd(19);
                    const score = entry.score.toLocaleString().padStart(8);
                    output += `    ${rank}${player}${score}\n`;
                });
            }

            output += `
================================================================================
COMMANDS
================================================================================

    [←/→]     Change Page              [ESC]       Back to Game Selection

================================================================================

READY: <span class="cursor">_</span>
`;
            terminalEl.innerHTML = output;
        }

        function render() {
            switch (currentView) {
                case "menu": renderMenu(); break;
                case "games": renderGames(); break;
                case "highscores": renderHighScores(); break;
                case "leaderboard-menu": renderLeaderboardMenu(); break;
                case "leaderboard": renderLeaderboard(); break;
            }
        }

        function navigate(direction) {
            let list = [];
            let itemsPerPage = ITEMS_PER_PAGE_GAMES;
            let maxIndex = 0;

            if (currentView === "menu") {
                maxIndex = 3;
            } else if (currentView === "games") {
                list = games;
                maxIndex = games.length - 1;
            } else if (currentView === "leaderboard-menu") {
                list = games.filter(g => g.available);
                maxIndex = list.length - 1;
            } else if (currentView === "leaderboard") {
                list = leaderboardData;
                itemsPerPage = ITEMS_PER_PAGE_SCORES;
                maxIndex = leaderboardData.length - 1;
            }

            if (direction === 'left') {
                if (currentPage > 0) {
                    currentPage--;
                    selectedIndex = currentPage * itemsPerPage;
                    render();
                }
                return;
            } else if (direction === 'right') {
                const totalPages = Math.ceil((maxIndex + 1) / itemsPerPage);
                if (currentPage < totalPages - 1) {
                    currentPage++;
                    selectedIndex = currentPage * itemsPerPage;
                    render();
                }
                return;
            } else if (direction === 'up') {
                if (selectedIndex > 0) {
                    selectedIndex--;
                } else if (currentPage > 0) {
                    currentPage--;
                    selectedIndex = Math.min((currentPage + 1) * itemsPerPage - 1, maxIndex);
                } else {
                    selectedIndex = maxIndex;
                }
            } else if (direction === 'down') {
                if (selectedIndex < maxIndex) {
                    selectedIndex++;
                } else if (currentPage < Math.ceil((maxIndex + 1) / itemsPerPage) - 1) {
                    currentPage++;
                    selectedIndex = currentPage * itemsPerPage;
                } else {
                    selectedIndex = 0;
                }
            }

            if (list.length > 0) {
                const start = currentPage * itemsPerPage;
                const end = Math.min(start + itemsPerPage, list.length);
                if (selectedIndex < start) selectedIndex = start;
                if (selectedIndex >= end) selectedIndex = end - 1;
            }

            render();
        }

        async function selectOption(index) {
            if (currentView === "menu") {
                if (index === 0) {
                    currentView = "games";
                    currentPage = 0;
                    selectedIndex = 0;
                    render();
                } else if (index === 1) {
                    document.getElementById('loadingOverlay').classList.add('active');
                    await fetchUserHighscores();
                    document.getElementById('loadingOverlay').classList.remove('active');
                    currentView = "highscores";
                    render();
                } else if (index === 2) {
                    currentView = "leaderboard-menu";
                    currentPage = 0;
                    selectedIndex = 0;
                    render();
                } else if (index === 3) {
                    logout();
                }
            } else if (currentView === "leaderboard-menu") {
                const availableGames = games.filter(g => g.available);
                const globalIndex = currentPage * ITEMS_PER_PAGE_GAMES + index;
                if (globalIndex < availableGames.length) {
                    selectedGame = availableGames[globalIndex].apiName;
                    document.getElementById('loadingOverlay').classList.add('active');
                    await fetchLeaderboard(selectedGame);
                    currentPage = 0;
                    selectedIndex = 0;
                    document.getElementById('loadingOverlay').classList.remove('active');
                    currentView = "leaderboard";
                    render();
                }
            }
        }

        function launchGame(globalIndex) {
            if (currentView !== "games" || globalIndex >= games.length) return;
            const game = games[globalIndex];
            if (game.available) {
                localStorage.setItem("currentGame", JSON.stringify({ name: game.name, selectedAt: Date.now() }));
                document.getElementById('loadingOverlay').classList.add('active');
                setTimeout(() => window.location.href = game.url, 800);
            }
        }

        function logout() {
            document.getElementById('loadingOverlay').classList.add('active');
            setTimeout(() => {
                localStorage.removeItem("currentUser");
                window.location.href = "../login/login.html";
            }, 800);
        }

        document.addEventListener("keydown", (e) => {
            switch (e.key) {
                case "ArrowUp": navigate('up'); e.preventDefault(); break;
                case "ArrowDown": navigate('down'); e.preventDefault(); break;
                case "ArrowLeft": navigate('left'); e.preventDefault(); break;
                case "ArrowRight": navigate('right'); e.preventDefault(); break;
                case "Enter":
                    if (currentView === "menu") {
                        selectOption(selectedIndex);
                    } else if (currentView === "games") {
                        launchGame(selectedIndex);
                    } else if (currentView === "leaderboard-menu") {
                        selectOption(selectedIndex - currentPage * ITEMS_PER_PAGE_GAMES);
                    }
                    e.preventDefault();
                    break;
                case "Escape":
                    if (currentView === "leaderboard") {
                        currentView = "leaderboard-menu";
                        currentPage = 0;
                        selectedIndex = 0;
                        selectedGame = null;
                        render();
                    } else if (currentView !== "menu") {
                        currentView = "menu";
                        currentPage = 0;
                        selectedIndex = 0;
                        selectedGame = null;
                        render();
                    }
                    e.preventDefault();
                    break;
                case "1": case "2": case "3": case "4": case "5":
                    const num = parseInt(e.key) - 1;
                    if (currentView === "menu") {
                        selectOption(num);
                    } else if (currentView === "games") {
                        const globalIndex = currentPage * ITEMS_PER_PAGE_GAMES + num;
                        if (globalIndex < games.length) launchGame(globalIndex);
                    }
                    e.preventDefault();
                    break;
            }
        });

        document.addEventListener("wheel", (e) => e.preventDefault(), { passive: false });

        async function init() {
            username = checkLogin();
            if (username) {
                username = username.toUpperCase();
                await fetchUserHighscores();
                render();
                setInterval(() => {
                    if (currentView === "menu") render();
                }, 1000);
                setTimeout(() => document.getElementById('loadingOverlay').classList.remove('active'), 500);
            }
        }

        init();
    </script>
</body>

</html>