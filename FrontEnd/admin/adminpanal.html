<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VTcade - ADMIN PANEL</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: black;
            color: #00ff00;
            font-family: "Courier New", monospace;
            font-size: 16px;
            line-height: 1.4;
            text-shadow: 0 0 4px #00ff00;
            overflow: hidden;
            cursor: none;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .container {
            width: 100%;
            max-width: 900px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        pre {
            white-space: pre;
            user-select: none;
            line-height: 1.4;
        }
        .terminal-output {
            font-size: 14px;
            text-align: left;
        }
        .logo {
            font-size: 10px;
            line-height: 1.1;
            text-align: center;
            margin-bottom: 0;
            animation: flicker 0.15s infinite alternate;
        }
        .subtitle {
            font-size: 14px;
            text-align: center;
            margin-top: 5px;
            display: block;
            color: #00ff00;
        }
        .highlight {
            background: #00ff00;
            color: black;
        }
        .red {
            color: #00ff00;
        }
        .yellow {
            color: #00ff00;
        }
        .dim {
            color: #006600;
        }
        body::after {
            content: "";
            position: fixed;
            inset: 0;
            background: repeating-linear-gradient(
                to bottom,
                rgba(0,0,0,0) 0px,
                rgba(0,255,0,0.04) 2px,
                rgba(0,0,0,0) 4px
            );
            pointer-events: none;
            z-index: 9999;
        }
        @keyframes blink {
            0%, 49% { opacity: 1; }
            50%, 100% { opacity: 0; }
        }
        .cursor {
            animation: blink 1s infinite;
        }
        @keyframes flicker {
            0% { opacity: 0.97; }
            100% { opacity: 1; }
        }
        .loading-overlay {
            position: fixed;
            inset: 0;
            background: black;
            color: #00ff00;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            font-family: "Courier New", monospace;
            text-align: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }
        .loading-overlay.active {
            opacity: 1;
            pointer-events: all;
        }
        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }
        .loading-dots::after {
            content: '';
            animation: dots 1.5s infinite;
        }
        
        @media (max-width: 768px) {
            body { font-size: 12px; padding: 10px; }
            .terminal-output { font-size: 11px; }
            .logo { font-size: 7px; }
            .subtitle { font-size: 11px; }
        }
        
        @media (max-width: 480px) {
            body { font-size: 10px; }
            .terminal-output { font-size: 9px; }
            .logo { font-size: 5px; }
            .subtitle { font-size: 9px; }
        }
    </style>
</head>
<body>
    <div class="loading-overlay active" id="loadingOverlay">
        <div class="loading-content">
            <pre>
================================================================================

<span class="loading-dots">LOADING</span>

================================================================================

            </pre>
        </div>
    </div>
    
    <div class="container">
        <pre class="logo">
██╗   ██╗████████╗ ██████╗ █████╗ ██████╗ ███████╗
██║   ██║╚══██╔══╝██╔════╝██╔══██╗██╔══██╗██╔════╝
██║   ██║   ██║   ██║     ███████║██║  ██║█████╗  
╚██╗ ██╔╝   ██║   ██║     ██╔══██║██║  ██║██╔══╝  
 ╚████╔╝    ██║   ╚██████╗██║  ██║██████╔╝███████╗
  ╚═══╝     ╚═╝    ╚═════╝╚═╝  ╚═╝╚═════╝ ╚══════╝
                    <span class="subtitle">Play Like It's 1985</span></pre>
        <pre id="terminal" class="terminal-output"></pre>
    </div>

    <script>
        const API_URL = "https://vtcade.onrender.com";
        const terminalEl = document.getElementById("terminal");
        let selectedIndex = 0;
        let currentView = "home";
        let adminAuth = null;
        let adminUsername = "UNKNOWN";
        let stats = {};
        let users = [];
        let games = [];
        let leaderboards = [];
        let selectedGame = null;

        function checkAuth() {
            const authData = localStorage.getItem("adminAuth");
            if (!authData) {
                window.location.href = "adminlogin.html";
                return null;
            }
            return JSON.parse(authData);
        }

        function getDateTime() {
            const now = new Date();
            const date = now.toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: '2-digit', 
                day: '2-digit' 
            });
            const time = now.toLocaleTimeString('en-US', { 
                hour12: false,
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            return { date, time };
        }

        function apiCall(endpoint, options = {}) {
            return fetch(`${API_URL}/api/admin${endpoint}`, {
                ...options,
                headers: {
                    'Content-Type': 'application/json',
                    username: adminAuth.username,
                    password: adminAuth.password,
                    ...options.headers
                }
            });
        }

        function renderHome() {
            const { date, time } = getDateTime();
            const statusColor = stats.status === "OK" ? "" : '<span class="red">';
            const statusEnd = stats.status === "OK" ? "" : '</span>';
            
            let output = `
================================================================================

SYSTEM STATUS: ${statusColor}${stats.status || "ONLINE"}${statusEnd}
ADMIN: ${adminUsername}
DATE: ${date}
TIME: ${time}

================================================================================
ADMIN DASHBOARD
================================================================================

    TOTAL USERS:              ${stats.users || 0}
    TOTAL GAMES:              ${stats.games || 0}

================================================================================
MAIN MENU
================================================================================

`;

            const menuItems = [
                { id: 1, name: "USER CONTROL" },
                { id: 2, name: "GAME CONTROL" },
                { id: 3, name: "SCOREBOARD CONTROL" },
                { id: 4, name: "MAINTENANCE MODE" },
                { id: 5, name: "LOGOUT" }
            ];

            menuItems.forEach((item, index) => {
                const isSelected = index === selectedIndex;
                const prefix = isSelected ? '>>>' : '   ';
                const line = `${prefix} [${item.id}] ${item.name}`;
                
                if (isSelected) {
                    output += `<span class="highlight">${line}</span>\n`;
                } else {
                    output += line + '\n';
                }
            });

            output += `
================================================================================
NAVIGATION
================================================================================

    [↑/↓]     Navigate Menu              [ENTER]     Select Option
    [1-5]     Direct Access              [ESC]       Exit

================================================================================

READY: <span class="cursor">_</span>

`;

            terminalEl.innerHTML = output;
        }

        function renderUsers() {
            const { date, time } = getDateTime();
            
            let output = `
================================================================================

SYSTEM STATUS: ${stats.status || "ONLINE"}
ADMIN: ${adminUsername}
DATE: ${date}
TIME: ${time}

================================================================================
USER CONTROL - ${users.length} USERS
================================================================================

`;

            if (users.length === 0) {
                output += `    <span class="dim">NO USERS FOUND</span>\n`;
            } else {
                users.forEach((user, index) => {
                    const isSelected = index === selectedIndex;
                    const prefix = isSelected ? '>>>' : '   ';
                    const bannedTag = user.isBanned ? '<span class="red">[BANNED]</span>' : '';
                    const verifiedTag = user.isVerified ? '<span class="yellow">[VERIFIED]</span>' : '';
                    
                    const line = `${prefix} [${index + 1}] ${user.username.padEnd(15)} ${user.email.padEnd(30)}`;
                    
                    if (isSelected) {
                        output += `<span class="highlight">${line.replace(/<span[^>]*>|<\/span>/g, '')}</span>\n`;
                        output += `        ${verifiedTag} ${bannedTag}\n\n`;
                    } else {
                        output += line + '\n';
                        output += `        ${verifiedTag} ${bannedTag}\n\n`;
                    }
                });
            }

            output += `
================================================================================
COMMANDS
================================================================================

    [↑/↓]     Navigate List              [B]         Ban User
    [U]       Unban User                 [D]         Delete User
    [R]       Refresh                    [ESC]       Back to Menu

================================================================================

READY: <span class="cursor">_</span>

`;

            terminalEl.innerHTML = output;
        }

        function renderGames() {
            const { date, time } = getDateTime();
            
            let output = `
================================================================================

SYSTEM STATUS: ${stats.status || "ONLINE"}
ADMIN: ${adminUsername}
DATE: ${date}
TIME: ${time}

================================================================================
GAME CONTROL - ${games.length} GAMES
================================================================================

`;

            if (games.length === 0) {
                output += `    <span class="dim">NO GAMES FOUND</span>\n`;
            } else {
                games.forEach((game, index) => {
                    const isSelected = index === selectedIndex;
                    const prefix = isSelected ? '>>>' : '   ';
                    const statusTag = game.isActive ? '<span class="yellow">[ENABLED]</span>' : '<span class="red">[DISABLED]</span>';
                    
                    const line = `${prefix} [${index + 1}] ${game.title.padEnd(25)} ${game.genre.padEnd(15)}`;
                    
                    if (isSelected) {
                        output += `<span class="highlight">${line.replace(/<span[^>]*>|<\/span>/g, '')}</span>\n`;
                        output += `        STATUS: ${statusTag}\n\n`;
                    } else {
                        output += line + '\n';
                        output += `        STATUS: ${statusTag}\n\n`;
                    }
                });
            }

            output += `
================================================================================
COMMANDS
================================================================================

    [↑/↓]     Navigate List              [E]         Enable Game
    [X]       Disable Game               [ESC]     Back to Menu

================================================================================

READY: <span class="cursor">_</span>

`;

            terminalEl.innerHTML = output;
        }

        function renderLeaderboards() {
            const { date, time } = getDateTime();
            
            let output = `
================================================================================

SYSTEM STATUS: ${stats.status || "ONLINE"}
ADMIN: ${adminUsername}
DATE: ${date}
TIME: ${time}

================================================================================
SCOREBOARD CONTROL
================================================================================

`;

            if (!selectedGame) {
                output += `SELECT A GAME TO VIEW LEADERBOARD:\n\n`;
                
                games.forEach((game, index) => {
                    const isSelected = index === selectedIndex;
                    const prefix = isSelected ? '>>>' : '   ';
                    const line = `${prefix} [${index + 1}] ${game.title}`;
                    
                    if (isSelected) {
                        output += `<span class="highlight">${line}</span>\n`;
                    } else {
                        output += line + '\n';
                    }
                });

                output += `
================================================================================
COMMANDS
================================================================================

    [↑/↓]     Navigate List              [ENTER]     Select Game
    [ESC]     Back to Menu

================================================================================
`;
            } else {
                output += `GAME: ${selectedGame.toUpperCase()}\n`;
                output += `SHOWING TOP ${Math.min(leaderboards.length, 100)} SCORES\n\n`;

                if (leaderboards.length === 0) {
                    output += `    <span class="dim">NO SCORES FOUND</span>\n`;
                } else {
                    leaderboards.forEach((entry, index) => {
                        const isSelected = index === selectedIndex;
                        const prefix = isSelected ? '>>>' : '   ';
                        const flagTag = entry.isFlagged ? '<span class="yellow">[FLAGGED]</span>' : '';
                        const username = entry.userId?.username || entry.username || 'UNKNOWN';
                        
                        const line = `${prefix} [${index + 1}] ${username.padEnd(15)} SCORE: ${String(entry.score).padStart(8)}`;
                        
                        if (isSelected) {
                            output += `<span class="highlight">${line.replace(/<span[^>]*>|<\/span>/g, '')}</span> ${flagTag}\n`;
                        } else {
                            output += line + ` ${flagTag}\n`;
                        }
                    });
                }

                output += `
================================================================================
COMMANDS
================================================================================

    [↑/↓]     Navigate List              [F]         Flag Score
    [D]       Delete Score               [Z]         Reset All Scores
    [ESC]     Back to Menu

================================================================================
`;
            }

            output += `
READY: <span class="cursor">_</span>

`;

            terminalEl.innerHTML = output;
        }

        function renderMaintenance() {
            const { date, time } = getDateTime();
            const modeStatus = stats.maintenanceMode ? '<span class="red">ENABLED</span>' : '<span class="yellow">DISABLED</span>';
            
            let output = `
================================================================================

SYSTEM STATUS: ${stats.status || "ONLINE"}
ADMIN: ${adminUsername}
DATE: ${date}
TIME: ${time}

================================================================================
MAINTENANCE MODE
================================================================================

    CURRENT STATUS:           ${modeStatus}

    WHEN ENABLED:
    - User logins blocked
    - Score submissions blocked
    - System locked message displayed

================================================================================
ACTIONS
================================================================================

`;

            const actions = [
                { id: 1, name: "ENABLE MAINTENANCE MODE", enabled: !stats.maintenanceMode },
                { id: 2, name: "DISABLE MAINTENANCE MODE", enabled: stats.maintenanceMode },
                { id: 3, name: "BACK TO MENU", enabled: true }
            ];

            let actionIndex = 0;
            actions.forEach((action, index) => {
                if (!action.enabled) return;
                
                const isSelected = actionIndex === selectedIndex;
                const prefix = isSelected ? '>>>' : '   ';
                const line = `${prefix} [${action.id}] ${action.name}`;
                
                if (isSelected) {
                    output += `<span class="highlight">${line}</span>\n`;
                } else {
                    output += line + '\n';
                }
                actionIndex++;
            });

            output += `
================================================================================
COMMANDS
================================================================================

    [↑/↓]     Navigate Menu              [ENTER]     Select Option
    [ESC]     Back to Menu

================================================================================

READY: <span class="cursor">_</span>

`;

            terminalEl.innerHTML = output;
        }

        function loadStats() {
            apiCall('/stats')
                .then(res => res.json())
                .then(data => {
                    stats = data;
                    render();
                })
                .catch(err => console.error(err));
        }

        function loadUsers() {
            apiCall('/users')
                .then(res => res.json())
                .then(data => {
                    users = data.users;
                    render();
                })
                .catch(err => console.error(err));
        }

        function loadGames() {
            apiCall('/games')
                .then(res => res.json())
                .then(data => {
                    games = data.games;
                    render();
                })
                .catch(err => console.error(err));
        }

        function loadLeaderboards(game) {
            const query = game ? `?game=${encodeURIComponent(game)}` : '';
            apiCall(`/leaderboards${query}`)
                .then(res => res.json())
                .then(data => {
                    leaderboards = data.leaderboards;
                    render();
                })
                .catch(err => console.error(err));
        }

        function banUser(userId) {
            if (!confirm("BAN THIS USER? Press OK to confirm.")) return;
            
            showLoading();
            apiCall(`/users/${userId}/ban`, { method: 'PUT' })
                .then(res => res.json())
                .then(() => {
                    hideLoading();
                    loadUsers();
                })
                .catch(err => {
                    hideLoading();
                    alert("ERROR: Failed to ban user");
                });
        }

        function unbanUser(userId) {
            showLoading();
            apiCall(`/users/${userId}/unban`, { method: 'PUT' })
                .then(res => res.json())
                .then(() => {
                    hideLoading();
                    loadUsers();
                })
                .catch(err => {
                    hideLoading();
                    alert("ERROR: Failed to unban user");
                });
        }

        function deleteUser(userId) {
            if (!confirm("DELETE USER? ALL DATA WILL BE REMOVED. Press OK to confirm.")) return;
            
            showLoading();
            apiCall(`/users/${userId}`, { method: 'DELETE' })
                .then(res => res.json())
                .then(() => {
                    hideLoading();
                    selectedIndex = 0;
                    loadUsers();
                })
                .catch(err => {
                    hideLoading();
                    alert("ERROR: Failed to delete user");
                });
        }

        function enableGame(gameId) {
            showLoading();
            apiCall(`/games/${gameId}/enable`, { method: 'PUT' })
                .then(res => res.json())
                .then(() => {
                    hideLoading();
                    loadGames();
                })
                .catch(err => {
                    hideLoading();
                    alert("ERROR: Failed to enable game");
                });
        }

        function disableGame(gameId) {
            showLoading();
            apiCall(`/games/${gameId}/disable`, { method: 'PUT' })
                .then(res => res.json())
                .then(() => {
                    hideLoading();
                    loadGames();
                })
                .catch(err => {
                    hideLoading();
                    alert("ERROR: Failed to disable game");
                });
        }

        function flagScore(entryId) {
            showLoading();
            apiCall(`/leaderboards/${entryId}/flag`, { method: 'PUT' })
                .then(res => res.json())
                .then(() => {
                    hideLoading();
                    loadLeaderboards(selectedGame);
                })
                .catch(err => {
                    hideLoading();
                    alert("ERROR: Failed to flag score");
                });
        }

        function deleteScore(entryId) {
            if (!confirm("DELETE THIS SCORE? Press OK to confirm.")) return;
            
            showLoading();
            apiCall(`/leaderboards/${entryId}`, { method: 'DELETE' })
                .then(res => res.json())
                .then(() => {
                    hideLoading();
                    selectedIndex = 0;
                    loadLeaderboards(selectedGame);
                })
                .catch(err => {
                    hideLoading();
                    alert("ERROR: Failed to delete score");
                });
        }

        function resetLeaderboard(game) {
            if (!confirm(`RESET ALL SCORES FOR ${game.toUpperCase()}? THIS CANNOT BE UNDONE. Press OK to confirm.`)) return;
            
            showLoading();
            apiCall(`/leaderboards/reset/${encodeURIComponent(game)}`, { method: 'DELETE' })
                .then(res => res.json())
                .then(() => {
                    hideLoading();
                    selectedIndex = 0;
                    loadLeaderboards(selectedGame);
                })
                .catch(err => {
                    hideLoading();
                    alert("ERROR: Failed to reset leaderboard");
                });
        }

        function enableMaintenance() {
            if (!confirm("ENABLE MAINTENANCE MODE? Users will be unable to login or submit scores. Press OK to confirm.")) return;
            
            showLoading();
            apiCall('/maintenance/enable', { method: 'PUT' })
                .then(res => res.json())
                .then(() => {
                    hideLoading();
                    loadStats();
                })
                .catch(err => {
                    hideLoading();
                    alert("ERROR: Failed to enable maintenance mode");
                });
        }

        function disableMaintenance() {
            showLoading();
            apiCall('/maintenance/disable', { method: 'PUT' })
                .then(res => res.json())
                .then(() => {
                    hideLoading();
                    loadStats();
                })
                .catch(err => {
                    hideLoading();
                    alert("ERROR: Failed to disable maintenance mode");
                });
        }

        function logout() {
            showLoading();
            setTimeout(() => {
                localStorage.removeItem("adminAuth");
                window.location.href = "adminlogin.html";
            }, 800);
        }

        function render() {
            switch(currentView) {
                case "home":
                    renderHome();
                    break;
                case "users":
                    renderUsers();
                    break;
                case "games":
                    renderGames();
                    break;
                case "leaderboards":
                    renderLeaderboards();
                    break;
                case "maintenance":
                    renderMaintenance();
                    break;
            }
        }

        function navigate(direction) {
            let maxIndex = 0;
            
            if (currentView === "home") maxIndex = 4;
            else if (currentView === "users") maxIndex = users.length - 1;
            else if (currentView === "games") maxIndex = games.length - 1;
            else if (currentView === "leaderboards" && !selectedGame) maxIndex = games.length - 1;
            else if (currentView === "leaderboards" && selectedGame) maxIndex = leaderboards.length - 1;
            else if (currentView === "maintenance") maxIndex = 2;
            
            if (direction === 'up') {
                selectedIndex = selectedIndex > 0 ? selectedIndex - 1 : maxIndex;
            } else if (direction === 'down') {
                selectedIndex = selectedIndex < maxIndex ? selectedIndex + 1 : 0;
            }
            render();
        }

        function showLoading() {
            document.getElementById('loadingOverlay').classList.add('active');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('active');
        }

        document.addEventListener("keydown", (e) => {
            switch(e.key) {
                case "ArrowUp":
                    navigate('up');
                    e.preventDefault();
                    break;
                    
                case "ArrowDown":
                    navigate('down');
                    e.preventDefault();
                    break;
                    
                case "Enter":
                    if (currentView === "home") {
                        if (selectedIndex === 0) { currentView = "users"; loadUsers(); }
                        else if (selectedIndex === 1) { currentView = "games"; loadGames(); }
                        else if (selectedIndex === 2) { currentView = "leaderboards"; loadGames(); selectedGame = null; }
                        else if (selectedIndex === 3) { currentView = "maintenance"; }
                        else if (selectedIndex === 4) { logout(); }
                        selectedIndex = 0;
                        render();
                    } else if (currentView === "leaderboards" && !selectedGame && games.length > 0) {
                        selectedGame = games[selectedIndex].title;
                        selectedIndex = 0;
                        loadLeaderboards(selectedGame);
                    } else if (currentView === "maintenance") {
                        if (selectedIndex === 0 && !stats.maintenanceMode) enableMaintenance();
                        else if (selectedIndex === 1 && stats.maintenanceMode) disableMaintenance();
                        else if (selectedIndex === 2) { currentView = "home"; selectedIndex = 0; loadStats(); }
                    }
                    e.preventDefault();
                    break;
                    
                case "Escape":
                    if (currentView === "leaderboards" && selectedGame) {
                        selectedGame = null;
                        selectedIndex = 0;
                        render();
                    } else if (currentView !== "home") {
                        currentView = "home";
                        selectedIndex = 0;
                        loadStats();
                    }
                    e.preventDefault();
                    break;
                    
                case "1":
                case "2":
                case "3":
                case "4":
                case "5":
                    if (currentView === "home") {
                        const index = parseInt(e.key) - 1;
                        if (index === 0) { currentView = "users"; loadUsers(); }
                        else if (index === 1) { currentView = "games"; loadGames(); }
                        else if (index === 2) { currentView = "leaderboards"; loadGames(); selectedGame = null; }
                        else if (index === 3) { currentView = "maintenance"; }
                        else if (index === 4) { logout(); }
                        selectedIndex = 0;
                        render();
                    }
                    e.preventDefault();
                    break;
                    
                case "b":
                case "B":
                    if (currentView === "users" && users.length > 0) {
                        banUser(users[selectedIndex]._id);
                    }
                    e.preventDefault();
                    break;
                    
                case "u":
                case "U":
                    if (currentView === "users" && users.length > 0) {
                        unbanUser(users[selectedIndex]._id);
                    }
                    e.preventDefault();
                    break;
                    
                case "d":
                case "D":
                    if (currentView === "users" && users.length > 0) {
                        deleteUser(users[selectedIndex]._id);
                    } else if (currentView === "leaderboards" && selectedGame && leaderboards.length > 0) {
                        deleteScore(leaderboards[selectedIndex]._id);
                    }
                    e.preventDefault();
                    break;
                    
                case "e":
                case "E":
                    if (currentView === "games" && games.length > 0) {
                        enableGame(games[selectedIndex]._id);
                    }
                    e.preventDefault();
                    break;
                    
                case "x":
                case "X":
                    if (currentView === "games" && games.length > 0) {
                        disableGame(games[selectedIndex]._id);
                    }
                    e.preventDefault();
                    break;
                    
                case "f":
                case "F":
                    if (currentView === "leaderboards" && selectedGame && leaderboards.length > 0) {
                        flagScore(leaderboards[selectedIndex]._id);
                    }
                    e.preventDefault();
                    break;
                    
                case "z":
                case "Z":
                    if (currentView === "leaderboards" && selectedGame) {
                        resetLeaderboard(selectedGame);
                    }
                    e.preventDefault();
                    break;
                    
                case "r":
                case "R":
                    if (currentView === "users") loadUsers();
                    else if (currentView === "games") loadGames();
                    else if (currentView === "leaderboards" && selectedGame) loadLeaderboards(selectedGame);
                    e.preventDefault();
                    break;
            }
        });

        document.addEventListener("wheel", (e) => {
            e.preventDefault();
        }, { passive: false });

        adminAuth = checkAuth();
        if (adminAuth) {
            adminUsername = adminAuth.username.toUpperCase();
            loadStats();
            
            setInterval(() => {
                if (currentView === "home") {
                    loadStats();
                }
            }, 5000);
            
            setTimeout(() => {
                hideLoading();
            }, 500);
        }
    </script>
</body>
</html>