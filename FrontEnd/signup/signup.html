<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VTcade - MAINFRAME REGISTRATION</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: black;
            color: #00ff00;
            font-family: "Courier New", monospace;
            font-size: 16px;
            line-height: 1.4;
            text-shadow: 0 0 4px #00ff00;
            overflow: hidden;
            cursor: none;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            width: 100%;
            max-width: 700px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        pre {
            white-space: pre;
            user-select: none;
            line-height: 1.4;
        }

        .terminal-output {
            font-size: 14px;
            text-align: left;
        }

        .logo {
            font-size: 10px;
            line-height: 1.1;
            text-align: center;
            margin-bottom: 0;
            animation: flicker 0.15s infinite alternate;
        }

        .subtitle {
            font-size: 14px;
            text-align: center;
            margin-top: 5px;
            display: block;
        }

        input {
            position: absolute;
            left: -9999px;
        }

        body::after {
            content: "";
            position: fixed;
            inset: 0;
            background: repeating-linear-gradient(to bottom,
                    rgba(0, 0, 0, 0) 0px,
                    rgba(0, 255, 0, 0.04) 2px,
                    rgba(0, 0, 0, 0) 4px);
            pointer-events: none;
            z-index: 9999;
        }

        @keyframes blink {

            0%,
            49% {
                opacity: 1;
            }

            50%,
            100% {
                opacity: 0;
            }
        }

        .cursor {
            animation: blink 1s infinite;
        }

        @keyframes flicker {
            0% {
                opacity: 0.97;
            }

            100% {
                opacity: 1;
            }
        }

        .highlight {
            background: #00ff00;
            color: black;
        }

        .error-text {
            color: #ff0000;
            text-shadow: 0 0 4px #ff0000;
        }

        .success-text {
            color: #00ff00;
            text-shadow: 0 0 4px #00ff00;
        }

        .loading-overlay {
            position: fixed;
            inset: 0;
            background: black;
            color: #00ff00;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            font-family: "Courier New", monospace;
            text-align: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .loading-overlay.active {
            opacity: 1;
            pointer-events: all;
        }

        .loading-content {
            font-size: 14px;
            line-height: 1.5;
        }

        @keyframes dots {

            0%,
            20% {
                content: '.';
            }

            40% {
                content: '..';
            }

            60%,
            100% {
                content: '...';
            }
        }

        .loading-dots::after {
            content: '';
            animation: dots 1.5s infinite;
        }

        @media (max-width: 768px) {
            body {
                font-size: 12px;
                padding: 10px;
            }

            .terminal-output {
                font-size: 11px;
            }

            .logo {
                font-size: 7px;
            }

            .subtitle {
                font-size: 11px;
            }
        }

        @media (max-width: 480px) {
            body {
                font-size: 10px;
            }

            .terminal-output {
                font-size: 9px;
            }

            .logo {
                font-size: 5px;
            }

            .subtitle {
                font-size: 9px;
            }
        }
    </style>
</head>

<body>
    <div class="loading-overlay active" id="loadingOverlay">
        <div class="loading-content">
            <pre>
================================================================================

<span class="loading-dots">LOADING</span>

================================================================================
            </pre>
        </div>
    </div>

    <div class="container">
        <pre class="logo">
██╗   ██╗████████╗ ██████╗ █████╗ ██████╗ ███████╗
██║   ██║╚══██╔══╝██╔════╝██╔══██╗██╔══██╗██╔════╝
██║   ██║   ██║   ██║     ███████║██║  ██║█████╗  
╚██╗ ██╔╝   ██║   ██║     ██╔══██║██║  ██║██╔══╝  
 ╚████╔╝    ██║   ╚██████╗██║  ██║██████╔╝███████╗
  ╚═══╝     ╚═╝    ╚═════╝╚═╝  ╚═╝╚═════╝ ╚══════╝
                    <span class="subtitle">Play Like It's 1980</span></pre>
        <pre id="terminal" class="terminal-output"></pre>
    </div>

    <input type="text" id="username-input">
    <input type="email" id="email-input">
    <input type="password" id="password-input">
    <input type="password" id="confirm-password-input">

    <script>
        // Configuration - Change this to your Render backend URL
        const API_URL = "https://vtcade.onrender.com";

        const terminalEl = document.getElementById("terminal");
        let currentField = 0;
        let username = "";
        let email = "";
        let password = "";
        let confirmPassword = "";
        let errorMessage = "";
        let successMessage = "";
        let isSubmitting = false;

        function validateEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        function validatePassword(password) {
            if (password.length < 6) {
                return "Password must be at least 6 characters";
            }
            return null;
        }

        function render() {
            const fields = ["USERNAME", "EMAIL", "PASSWORD", "CONFIRM PASSWORD"];
            const values = [username, email, password, confirmPassword];

            let output = `\n================================================================================\nNEW USER REGISTRATION\n================================================================================\n\n`;

            fields.forEach((field, index) => {
                const isSelected = currentField === index;
                const prefix = isSelected ? '>>>' : '   ';
                const value = values[index];
                const displayValue = (index === 2 || index === 3) && value ? '*'.repeat(value.length) : value;
                const cursor = isSelected ? '<span class="cursor">_</span>' : '';

                let line = `${prefix} ${field}: ${displayValue}${cursor}`;

                if (isSelected) {
                    output += `<span class="highlight">${line}</span>\n`;
                } else {
                    output += line + '\n';
                }
            });

            output += '\n';

            const submitSelected = currentField === 4;
            const submitPrefix = submitSelected ? '>>>' : '   ';
            const submitText = isSubmitting ? '[ REGISTERING... ]' : '[ REGISTER ]';
            let submitLine = `${submitPrefix} ${submitText}`;

            if (submitSelected) {
                output += `<span class="highlight">${submitLine}</span>\n`;
            } else {
                output += submitLine + '\n';
            }

            output += '\n';

            if (errorMessage) {
                output += `<span class="error-text">ERROR: ${errorMessage}</span>\n\n`;
            }
            if (successMessage) {
                output += `<span class="success-text">SUCCESS: ${successMessage}</span>\n\n`;
            }

            output += `\n================================================================================\nCOMMAND REFERENCE\n================================================================================\n\n    [↑/↓]              Navigate Fields\n    [ENTER]            Execute Selected\n    [TAB]              Switch to Login Page\n\n================================================================================\n\nREADY: <span class="cursor">_</span>\n\n`;

            terminalEl.innerHTML = output;
        }

        function navigateField(direction) {
            if (isSubmitting) return;

            errorMessage = "";
            successMessage = "";

            if (direction === 'next') {
                currentField = currentField < 4 ? currentField + 1 : 0;
            } else if (direction === 'prev') {
                currentField = currentField > 0 ? currentField - 1 : 4;
            }
            render();
        }

        function handleTyping(key) {
            if (isSubmitting) return;
            if (currentField === 4) return;

            errorMessage = "";
            successMessage = "";

            if (key === 'Backspace') {
                if (currentField === 0) username = username.slice(0, -1);
                else if (currentField === 1) email = email.slice(0, -1);
                else if (currentField === 2) password = password.slice(0, -1);
                else if (currentField === 3) confirmPassword = confirmPassword.slice(0, -1);
            } else if (key.length === 1) {
                if (currentField === 0) {
                    if (username.length < 10) {  // <-- max 10 characters
                        username += key;
                    } else {
                        errorMessage = "Username cannot exceed 10 characters"; // optional
                    }
                } else if (currentField === 1) email += key;
                else if (currentField === 2) password += key;
                else if (currentField === 3) confirmPassword += key;
            }
            render();
        }

        async function submitForm() {
            if (isSubmitting) return;
            if (currentField !== 4) return;

            errorMessage = "";
            successMessage = "";

            if (!username || !email || !password || !confirmPassword) {
                errorMessage = "All fields are required";
                console.warn("Missing required fields");
                render();
                return;
            }

            if (!validateEmail(email)) {
                errorMessage = "Invalid email format";
                render();
                return;
            }

            const passwordError = validatePassword(password);
            if (passwordError) {
                errorMessage = passwordError;
                render();
                return;
            }

            if (password !== confirmPassword) {
                errorMessage = "Passwords do not match";
                render();
                return;
            }

            isSubmitting = true;
            render();

            try {
                console.log("Sending registration request...");
                console.log("API URL:", API_URL);

                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 60000);

                const res = await fetch(`${API_URL}/api/auth/signup`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Accept": "application/json"
                    },
                    body: JSON.stringify({ username, email, password }),
                    signal: controller.signal
                });

                clearTimeout(timeoutId);

                console.log("Response status:", res.status);

                let data;
                try {
                    data = await res.json();
                    console.log("Response data:", data);
                } catch (parseErr) {
                    console.error("Failed to parse response:", parseErr);
                    errorMessage = "Invalid server response";
                    isSubmitting = false;
                    render();
                    return;
                }

                if (!res.ok) {
                    errorMessage = data?.message || `Server error (${res.status})`;
                    isSubmitting = false;
                    render();
                    return;
                }

                if (!data?.username) {
                    errorMessage = "Invalid server response";
                    console.error("No username in response:", data);
                    isSubmitting = false;
                    render();
                    return;
                }

                localStorage.setItem("currentUser", data.username);
                console.log("Saved user:", data.username);

                successMessage = "Registration successful";
                isSubmitting = false;
                render();

                setTimeout(() => {
                    const overlay = document.getElementById('loadingOverlay');
                    overlay.classList.add('active');

                    setTimeout(() => {
                        window.location.href = "../dashboard/dashboard.html";
                    }, 800);
                }, 1000);

            } catch (err) {
                console.error("Network error:", err);

                if (err.name === 'AbortError') {
                    errorMessage = "Request timeout. Server may be waking up, please try again.";
                } else if (err.message.includes('Failed to fetch')) {
                    errorMessage = "Cannot connect to server. Check your internet connection.";
                } else {
                    errorMessage = "Network error: " + err.message;
                }

                isSubmitting = false;
                render();
            }
        }

        document.addEventListener("keydown", (e) => {
            if (e.key === "Tab") {
                e.preventDefault();
                const overlay = document.getElementById('loadingOverlay');
                overlay.classList.add('active');
                setTimeout(() => {
                    window.location.href = "../login/login.html";
                }, 800);
            } else if (e.key === "ArrowDown") {
                e.preventDefault();
                navigateField('next');
            } else if (e.key === "ArrowUp") {
                e.preventDefault();
                navigateField('prev');
            } else if (e.key === "Enter") {
                e.preventDefault();
                if (currentField === 4) {
                    submitForm();
                }
            } else if (e.key === "Backspace" || (e.key.length === 1 && !e.ctrlKey && !e.metaKey)) {
                e.preventDefault();
                handleTyping(e.key);
            }
        });

        document.addEventListener("wheel", (e) => {
            e.preventDefault();
        }, { passive: false });

        render();

        setTimeout(() => {
            const overlay = document.getElementById('loadingOverlay');
            overlay.classList.remove('active');
        }, 500);
    </script>
</body>

</html>